<?php// Copyright (c) 2012 Rubén Domínguez//  // This file is part of phpPMS.//// phpPMS is free software: you can redistribute it and/or modify// it under the terms of the GNU General Public License as published by// the Free Software Foundation, either version 3 of the License, or// (at your option) any later version.//// phpPMS is distributed in the hope that it will be useful,// but WITHOUT ANY WARRANTY; without even the implied warranty of// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the// GNU General Public License for more details.//// You should have received a copy of the GNU General Public License// along with phpPMS.  If not, see <http://www.gnu.org/licenses/>./** * * @author nuxsmin * @link http://www.cygnux.org/phppms *  */define('PMS_ROOT', '..');include_once (PMS_ROOT."/inc/includes.php");check_session(FALSE,TRUE);function checkLogin(){    global $LANG;    $strUserLogin = ( isset($_POST["user"]) ) ? $_POST["user"] : "";    $strUserPass = ( isset($_POST["pass"]) ) ? $_POST["pass"] : "";    $strMPass = ( isset($_POST["mpass"]) ) ? $_POST["mpass"] : "";    $resXML = array( "status" => 0, "description" => "");    $objUser = new Users;    if ( ! $strUserLogin OR ! $strUserPass ){        $resXML["status"] = 1;        $resXML["description"] = $LANG['msg'][0];    } elseif( $objUser->authUserLDAP($strUserLogin, $strUserPass) ){ // Autentificamos por LDAP        if ( $objUser->checkUserLDAP($strUserLogin) ){ // Verificamos si el usuario existe en la BBDD            if ( ! $objUser->getUserInfo($strUserLogin) ){ // Obtenemos los datos del usuario                $resXML["status"] = 1;                $resXML["description"] = $LANG['msg'][1];                Common::wrLogInfo($LANG['event'][0],$LANG['eventdesc'][0]." (1)");                return $resXML;				            }            if ( ! $objUser->updateUserLDAP() ){ // Actualizamos la clave del usuario en MySQL                $resXML["status"] = 1;                $resXML["description"] = $LANG['msg'][1];                Common::wrLogInfo($LANG['event'][0],$LANG['eventdesc'][1]);                return $resXML;				            }				            if ( ! $objUser->checkUserMPass($strUserPass) AND ! $strMPass ){ // Comprobamos la clave maestra del usuario                $resXML["status"] = 3;                $resXML["description"] = $LANG['msg'][2];                return $resXML;            } elseif ( $strMPass ) {                if ( ! $objUser->updateUserMPass($strMPass,$strUserPass) ){                    $resXML["status"] = 4;                    $resXML["description"] = $LANG['msg'][3];                    return $resXML;                }            }             if ( $objUser->getUserMPass($strUserPass) ){ // Obtenemos la clave maestra del usuario                $objUser->setUserSession(); // Establecemos las variables de sesión                Common::wrLogInfo($LANG['event'][0], $LANG['eventdesc'][11].":".$_SESSION['uname'].";".$LANG['eventdesc'][12].":".$_SESSION['uprofile'].";".$LANG['eventdesc'][13].":".$_SESSION['ugroup'].";".$LANG['eventdesc'][11].":".$_SERVER['REMOTE_ADDR']);                // Combrobamos si el usuario pertenece al grupo 99 para enviar un correo de activación                if ( $objUser->arrUserInfo['intUGroupFid'] == 99 ){                    Common::sendEmail($LANG['eventdesc'][11].": ".$objUser->arrUserInfo['vacUName']." (".$objUser->arrUserInfo['vacULogin']."), ".$LANG['eventdesc'][15]);                }                $resXML["status"] = 0;                $resXML["description"] = "index.php";            }        } else {            if ( ! $objUser->newUserLDAP() ){ // Creamos el usuario de LDAP en MySQL                $resXML["status"] = 1;                $resXML["description"] = $LANG['msg'][1];                Common::wrLogInfo($LANG['event'][0], $LANG['eventdesc'][2]);                return $resXML;            }            if ( ! $objUser->getUserInfo($strUserLogin) ){ // Obtenemos los datos del nuevo usuario creado                $resXML["status"] = 1;                $resXML["description"] = $LANG['msg'][1];                Common::wrLogInfo($LANG['event'][0],$LANG['eventdesc'][0]." (2)");                return $resXML;				            }            if ( ! $objUser->checkUserMPass($strUserPass) AND ! $strMPass ){ // Comprobamos la clave maestra del usuario                $resXML["status"] = 3;                $resXML["description"] = $LANG['msg'][2];                return $resXML;            } elseif ( $strMPass ) {                if ( ! $objUser->updateUserMPass($strMPass,$strUserPass) ){                    $resXML["status"] = 4;                    $resXML["description"] = $LANG['msg'][3];                    return $resXML;                }                $resXML["status"] = 5;                $resXML["description"] = $LANG['msg'][4];            }             if ( $objUser->getUserMPass($strUserPass) ){ // Obtenemos la clave maestra del usuario                $objUser->setUserSession(); // Establecemos las variables de sesión                // Combrobamos si el usuario pertenece al grupo 99 para enviar un correo de activación                if ( $objUser->arrUserInfo['intUGroupFid'] == 99 ){                    Common::sendEmail($LANG['eventdesc'][11].": ".$objUser->arrUserInfo['vacUName']." (".$objUser->arrUserInfo['vacULogin']."), ".$LANG['eventdesc'][15]);                }            }        }    } else {        $resPass = $objUser->checkUserPass($strUserLogin,$strUserPass);        if ( $resPass == 1 ){ // Autentificamos con la BBDD            if ( ! $objUser->getUserInfo($strUserLogin) ){ // Obtenemos los datos del usuario                $resXML["status"] = 1;                $resXML["description"] = $LANG['msg'][1];                Common::wrLogInfo($LANG['event'][1],$LANG['eventdesc'][0]." (3)");                return $resXML;				            }            if ( ! $objUser->checkUserMPass($strUserPass) AND ! $strMPass ){ // Comprobamos la clave maestra del usuario                $resXML["status"] = 3;                $resXML["description"] = $LANG['msg'][2];                return $resXML;            } elseif ( $strMPass ) {                if ( ! $objUser->updateUserMPass($strMPass,$strUserPass) ){                    $resXML["status"] = 4;                    $resXML["description"] = $LANG['msg'][3];                    return $resXML;                }                $resXML["status"] = 5;                $resXML["description"] = $LANG['msg'][4];            }             if ( $objUser->getUserMPass($strUserPass) ){ // Obtenemos la clave maestra del usuario                $objUser->setUserSession(); // Establecemos las variables de sesión                Common::wrLogInfo($LANG['event'][1],$LANG['eventdesc'][11].":".$_SESSION['uname'].";".$LANG['eventdesc'][12].":".$_SESSION['uprofile'].";".$LANG['eventdesc'][13].":".$_SESSION['ugroup'].";".$LANG['eventdesc'][11].":".$_SERVER['REMOTE_ADDR']);                // Combrobamos si el usuario pertenece al grupo 99 para enviar un correo de activación                if ( $objUser->arrUserInfo['intUGroupFid'] == 99 ){                    Common::sendEmail($LANG['eventdesc'][11].": ".$objUser->arrUserInfo['vacUName']." (".$objUser->arrUserInfo['vacULogin']."), ".$LANG['eventdesc'][15]);                }                // Devolvemos que se está accediendo mediante MySQL                $resXML["status"] = 2;                $resXML["description"] = $LANG['msg'][5];            }        } elseif ( $resPass == 2 ){ // Verificamos que el usuario esté activo            Common::wrLogInfo($LANG['msg'][6],$LANG['eventdesc'][11].": ".$strUserLogin.";".$LANG['eventdesc'][14].":".$_SERVER['REMOTE_ADDR']);            $resXML["status"] = 1;            $resXML["description"] = $LANG['msg'][6];        } else {            Common::wrLogInfo($LANG['event'][20],$LANG['eventdesc'][11].": ".$strUserLogin.";".$LANG['eventdesc'][14].":".$_SERVER['REMOTE_ADDR']);            $resXML["status"] = 1;            $resXML["description"] = $LANG['msg'][7];        }    }    return $resXML;}if ( $_POST["login"] ) Common::printXML(checkLogin());?>